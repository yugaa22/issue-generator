
name: Java CI with fina
on:
  workflow_call: 
  push:
    branches: [ "master" ]
env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Xmx2g -Xms2g
  CONTAINER_REGISTRY: quay.io/opsmxpublic

jobs:
  gradle-igor:
    runs-on: ubuntu-latest
    #container:
    #  image: mydockerhubusername/mydockerimage:latest
    steps:
    - name: Checkout OpsMx Igor repo
      uses: actions/checkout@v2
      with:
        repository: opsmx/igor
        ref: refs/heads/v4.7.3-1.28.4
    - uses: actions/setup-java@v2
      with:
        distribution: zulu
        java-version: 11
    - run: echo "💡 The OpsMx/igor repository has been cloned to the runner."
    - run: echo "🖥️ The workflow is now ready to test your code on the runner."
    - run: echo "🍏 This job's status is ${{ job.status }}."
    
    - name: Prepare build variables
      id: build_variables
      run: |
          echo ::set-output name=REPO::"ubi8-spin-igor"
          echo ::set-output name=VERSION::"yuga-$(git rev-parse --short HEAD)-$(date --utc +'%Y%m%d%H%M')"
    - name: Build
      env:
        ORG_GRADLE_PROJECT_version: ${{ steps.build_variables.outputs.VERSION }}
      run: ./gradlew --no-daemon -PenableCrossCompilerPlugin=true igor-web:installDist -x test
    - name: dockerBuildpush
        # Only run this on repositories in the 'spinnaker' org, not on forks.
        #if: startsWith(github.repository, ‘yugaa22/‘)
      uses: docker/build-push-action@v2
      with:
        context: .
        file: docker/ubi8/Dockerfile
        push: false
        tags: |
          "${{ env.CONTAINER_REGISTRY }}/${{ steps.build_variables.outputs.REPO }}:${{ steps.build_variables.outputs.VERSION }}"
    - id: get-build-name
      run: |
            imageName=${{ env.CONTAINER_REGISTRY }}/${{ steps.build_variables.outputs.REPO }}:${{ steps.build_variables.outputs.VERSION }}
            echo "igor=$imageName" >> $GITHUB_OUTPUT
